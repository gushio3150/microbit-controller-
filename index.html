<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>micro:bit Bluetooth ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</title>
  <style>
    body {
      background-color: black;
      color: white;
      text-align: center;
      font-family: sans-serif;
      margin: 0;
      padding: 50px 20px;
    }
    h1 {
      margin-bottom: 30px;
    }
    .status {
      font-size: 22px;
      margin-bottom: 30px;
      color: yellow;
    }
    .connect-btn {
      width: 300px;
      height: 70px;
      font-size: 26px;
      margin-bottom: 40px;
      background-color: #2196F3;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
    }
    .control-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-gap: 30px;
      justify-items: center;
      align-items: center;
      max-width: 400px;
      margin: 0 auto;
    }
    .control-buttons button {
      width: 120px;
      height: 120px;
      font-size: 32px;
      border-radius: 20px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      box-shadow: 0 5px #2e7d32;
    }
    .control-buttons button:active {
      box-shadow: none;
      transform: translateY(4px);
    }
  </style>
</head>
<body>

  <h1>micro:bit Bluetooth ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</h1>

  <button class="connect-btn" onclick="connectBluetooth()">ğŸ”— Bluetoothæ¥ç¶š</button>
  <div class="status" id="status">æœªæ¥ç¶š</div>

  <div class="control-buttons">
    <div></div>
    <button onclick="sendCommand('forward')">â†‘<br>å‰</button>
    <div></div>

    <button onclick="sendCommand('left')">â†<br>å·¦</button>
    <div></div>
    <button onclick="sendCommand('right')">â†’<br>å³</button>

    <div></div>
    <button onclick="sendCommand('back')">â†“<br>å¾Œ</button>
    <div></div>
  </div>

  <script>
    let bluetoothDevice;
    let bluetoothCharacteristic;

    async function connectBluetooth() {
      try {
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          // micro:bitã®ãƒ•ãƒ«ãƒãƒ¼ãƒ ã€ŒBBC micro:bitã€ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ã¾ã™
          filters: [{
            namePrefix: 'BBC micro:bit'
          }],
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'] // UARTã‚µãƒ¼ãƒ“ã‚¹UUID
        });

        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        bluetoothCharacteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e'); // RX Characteristic

        document.getElementById('status').innerText = 'âœ… æ¥ç¶šæ¸ˆã¿';
        document.getElementById('status').style.color = 'lightgreen';

        // åˆ‡æ–­æ™‚ã®å‡¦ç†
        bluetoothDevice.addEventListener('gattserverdisconnected', () => {
          document.getElementById('status').innerText = 'âŒ æ¥ç¶šè§£é™¤';
          document.getElementById('status').style.color = 'red';
          bluetoothCharacteristic = null;
          bluetoothDevice = null;
        });
      } catch (error) {
        console.error(error);
        document.getElementById('status').innerText = 'âŒ æ¥ç¶šå¤±æ•—';
        document.getElementById('status').style.color = 'red';
      }
    }

    async function sendCommand(command) {
      if (!bluetoothCharacteristic) {
        alert("BluetoothãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼");
        return;
      }

      const encoder = new TextEncoder();
      try {
        await bluetoothCharacteristic.writeValue(encoder.encode(command + "\n"));
        console.log("é€ä¿¡: " + command);
      } catch (error) {
        console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
        alert("ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }
  </script>

</body>
</html>